## 问题抽象与关键结构

* 给定连通无向图 $G=(V,E)$，标记集合 $S\subseteq V$（可疑站点）。
* 我们要从输入边中选出一棵生成树 $T$ 与一个中心点 $x$，满足：对任意目标点 $v$，**在 $T$ 中从 $x$ 到 $v$ 的唯一路径上，经过的可疑站点数 $\le 1$**。
* 允许 $x$ 是非可疑；若 $x\in S$，则路径起点就已经是可疑，若还存在别的可疑点在任何一条到达路径上，就会**超出 1 个**——因此除非 $k=1$，一般必须让 $x\notin S$。

---

## 充分必要条件（核心结论）

令 $H = G - S$（从图中删去全部可疑点，仅保留非可疑点及其边），把 $H$ 的连通分量记为 $\mathcal{C}=\{C_1,\dots,C_p\}$。

> **定理（充要条件）**：
> 当 $k=0$ 时，显然任意生成树、任意 $x$ 都合法。
> 当 $k=1$ 时，选择唯一的可疑点为中心 $x$，任意生成树都合法。
> 当 $k\ge 2$ 时，存在合法的 $(T,x)$ **当且仅当** 存在某个非可疑分量 $C^\star\in \mathcal{C}$，使得**每一个可疑点 $s\in S$ 都有至少一条输入边直接连向 $C^\star$**（即 $s$ 在原图中与 $C^\star$ 内某个非可疑点相邻）。

**直觉：**
把图收缩为二部骨架 $B$：一侧是可疑点 $S$，另一侧是非可疑分量 $\mathcal{C}$，若 $s\in S$ 与 $C_i$ 有至少一条跨边，则在 $B$ 中连一条边 $s\!-\!C_i$。我们输出的生成树 $T$ 在“跨边层面”对应 $B$ 的一棵树。
要保证“从中心 $x$ 到任意节点的路径至多经过 1 个可疑”，等价于让骨架 $B$ 中从 $x$ 所在分量 $C^\star$ 到任意节点的骨架路径**至多穿过 1 个 $S$-侧节点**。这强迫所有可疑点都必须是 $C^\star$ 的**直接邻居**（骨架距离 1）。否则，就会出现骨架路径 $C^\star \to s_1 \to C_j \to s_2 $ 之类，路径包含 $\ge 2$ 个可疑节点，违背条件。

---

## 线性时间构造法（满足条件即能构造）

若 $k=0$：任意从 1 或任意点做 BFS/DFS 出一棵生成树，$x$ 随便选（比如 1）。

若 $k=1$：设唯一可疑点为 $s$，取 $x=s$，从 $s$ 做 BFS 出一棵生成树即可。对任意目标路径起点就是唯一的可疑点，**≤1** 成立。

若 $k\ge 2$：

1. **分量划分**：在 $H=G-S$ 上做 BFS，求出每个非可疑点的分量 `comp[u]`，并且在每个分量内顺便记录一棵**分量生成树**（把这些边以后直接放进答案）。
2. **统计“共同邻接”分量**：对每个可疑点 $s$，遍历它所有邻居 $v\notin S$，把 $comp[v]$ 去重后对该分量的计数 `cnt[comp[v]]++`。
   扫完所有可疑点后，若存在分量 $C^\star$ 满足 `cnt[C^\star] == k`，则它就是**满足充要条件**的公共分量（每个可疑点都与它相邻）。若不存在，直接输出 **NO**。
3. **选中心**：在 $C^\star$ 中任选一个点 $x$（比如该分量 BFS 的起点）。
4. **拼接骨架（两层星形）**：

   * 对于每个可疑点 $s$：在输入边里找一条 $s$ 连向 $C^\star$ 的边 $s-u$（一定存在），把这条边加入答案。这样所有 $S$ 都以 1 条边**直接挂到 $C^\star$**。
   * 对于每个其它分量 $C\neq C^\star$：从它与 $S$ 的所有跨边里，**任取一条** $s-v$（$v\in C$）加入答案（每个分量只选一条，避免成环）。
     这样整个骨架就是一棵“以 $C^\star$ 为根、深度至多 2 的树”：
     $C^\star \leftrightarrow s \leftrightarrow C$。
5. 与第 1 步中每个分量的内部树边合在一起，总边数正好是

   $$
   \sum_C(|C|-1) + k + (|\mathcal{C}|-1) \;=\; (n-k) - |\mathcal{C}| + k + |\mathcal{C}| - 1 \;=\; n-1
   $$

   因此得到一棵生成树。
   从 $x\in C^\star$ 到：

   * $C^\star$ 内任意点：路径不含可疑；
   * 任意可疑 $s$：路径形如 $x\leadsto u\in C^\star \to s$，仅 1 个可疑 $s$；
   * 其它分量 $C$ 内任意点 $v$：路径形如 $x\leadsto C^\star \to s \to v$，也仅 1 个可疑 $s$。
     条件完全满足。

> 反之（必要性）：若存在合法 $(T,x)$，把 $T$ 的非可疑点收缩为分量，得到骨架树 $B_T$。从 $x$ 所在分量 $C^\star$ 到任意可疑点的骨架路径**最多含一个**可疑节点——即骨架距离必须为 1。因此每个可疑点都直接邻接 $C^\star$。所以“存在公共邻接分量”是必要的。
> 结合上面的构造（充分性），给出充要性证明。

---

## 复杂度与实现细节

* 所有步骤都是**线性**：一次在 $H$ 上的 BFS（只遍历非可疑点与其边）、两次遍历“可疑点的邻接表”（一次计数去重、一次挑边），总体 **$O(n+m)$**。
* 去重用**时间戳数组**避免对每个可疑点开 `set`/排序，内存与时间都线性。
* 仅用迭代 BFS，**不递归**，避免栈溢出。
* 若 $k=0$ 或 $k=1$ 走专门的**快速分支**，无需做分量统计。

---

## 边界讨论

* 若 $k=n$：只有在 $n=1$（且 $k=1$）时可行，否则必定 **NO**（中心若是可疑，目标若是另一可疑，路径有 ≥2 个可疑）。我们的判定会给出 **NO**。
* 若存在可疑点仅与可疑点相邻（没有任何非可疑邻居）：当 $k\ge 2$ 时一定 **NO**（没有公共非可疑分量可挂），算法也会判出 **NO**。
* 原图连通保证：对每个非可疑分量都必有某个可疑点邻接它，否则整图无法连通。构造时“每个其它分量选一条跨边”总能找到。

---

## 正确性要点小结

* **必要性**：若存在合法 $T,x$，把非可疑收缩成分量骨架 $B_T$ 后，从 $x$ 所在分量 $C^\star$ 到任意目标的骨架路径**至多含 1 个**可疑点；于是每个可疑点必须是 $C^\star$ 的邻居。
* **充分性**：若存在公共分量 $C^\star$ 与全部可疑点相邻，按上面两层骨架构造，把所有可疑点**直接挂在 $C^\star$**，其它分量各挂到某个可疑点，显然从 $x\in C^\star$ 出发任何路径至多遇到 1 个可疑点。
* **生成树性**：分量内部树边合并骨架边，边数恰为 $n-1$，且连通无环。
* **复杂度**：$O(n+m)$ 时间，$O(n+m)$ 空间；不使用递归，安全通过大数据。

---

如果你要我把 `isdebug=false` 切换成评测文件读写或需要我给出一份**随机小数据生成 + 校验脚本**来双向验证该构造的充要性，我也可以补上。
另外，若你希望我把这套算法拓展为**在线判定/构造**或在**多组数据**输入时的复用优化，我也可以顺带给出模板化封装。
